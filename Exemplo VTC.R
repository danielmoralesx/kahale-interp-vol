source("kahale_volatility.R")

## Dados VTC 10/06/2016 ----

dataref <- "2016-06-10"
maturity <- c(15, 36, 59, 80, 100, 120, 142, 164, 182, 205, 223, 245, 266, 330,
              391, 452, 515, 641, 702, 764) / 252
rate <- log(1 + c(14.13, 14.11, 14.09, 14.00, 13.85, 13.79, 13.68, 13.52, 13.43,
                  13.32, 13.20, 13.08, 12.98, 12.73, 12.55, 12.47, 12.41, 12.30,
                  12.31, 12.31) / 100)
divy <- c(-21.21, -6.65, -3.20, -1.65, -0.82, -0.24, 0.20, 0.53, 0.77, 0.99,
          1.17, 1.35, 1.46, 1.80, 2.05, 2.24, 2.43, 2.74, 2.88, 2.99) / 100
delta <- c(.05, .1, .25, .35, .5, .65, .75, .9, .95) # = N(d_1)
forward <- c(3452.92700, 3481.31545, 3515.42421, 3545.85710, 3573.93145,
             3602.29117, 3632.76659, 3661.76963, 3684.85112, 3715.17965,
             3736.03894, 3762.49834, 3788.88539, 3865.53942, 3936.48994,
             4012.11542, 4089.44508, 4242.22331, 4320.26066, 4402.43812)
spot <- forward * exp(-(rate - divy) * maturity)

strike <- matrix(
  c(3803.33642,	4040.79684,	4270.18098,	4476.35245,	4665.67300,	4855.79144,	5062.89492,	5274.97303,	5423.96872,	5620.76063,	5829.46115,	6042.38066,	6150.81735,	7059.74763,	7356.75262,	8418.65340,	9220.09435,	10052.20934, 11634.84102,	12687.83022,
    3711.96670,	3897.48163,	4071.95393,	4225.25852,	4365.32800,	4505.17540,	4646.18856,	4806.71897,	4924.24809,	5066.68796,	5185.56774,	5330.51627,	5478.25463,	5934.99752,	6230.41051,	6766.65677,	7231.18826,	7954.15800,	 8642.73206,	9184.87774,
    3579.64202,	3683.34830,	3780.50995,	3863.16818,	3941.16059,	4015.80931,	4093.11130,	4170.61382,	4233.64793,	4312.92047,	4369.44445,	4438.93079,	4510.37984,	4717.67583,	4905.31781,	5123.10763,	5340.93460,	5756.88492,	 6008.95337,	6242.44677,
    3524.21737,	3595.17984,	3664.70644,	3724.63299,	3779.93391,	3834.88596,	3891.83650,	3949.43405,	3994.31625,	4049.54372,	4090.62113,	4141.67326,	4187.81386,	4342.64244,	4485.54674,	4636.55211,	4792.81325,	5106.11032,	 5274.78355,	5440.93493,
    3456.91697,	3490.54437,	3530.08684,	3565.89186,	3599.02302,	3632.68173,	3669.19909,	3704.05509,	3732.13692,	3768.99864,	3793.95621,	3827.01511,	3860.23113,	3956.40921,	4050.06104,	4146.12010,	4247.67534,	4455.29004,	 4560.14661,	4669.56295,
    3394.86984,	3396.14543,	3411.48106,	3426.86648,	3442.83118,	3460.63784,	3480.47416,	3499.70498,	3515.78136,	3537.30607,	3552.49403,	3571.17623,	3590.69865,	3647.59685,	3700.38114,	3762.49122,	3825.90461,	3953.51058,	 4021.87555,	4094.72548,
    3350.58673,	3330.16527,	3329.52057,	3332.60241,	3337.23140,	3344.30191,	3353.68790,	3362.95406,	3371.61507,	3383.89903,	3392.84402,	3403.09529,	3414.32066,	3446.97774,	3473.11861,	3517.19124,	3558.22267,	3637.57395,	 3687.68954,	3740.36782,
    3259.18728,	3196.76406,	3169.54321,	3147.08492,	3123.82078,	3113.30702,	3101.13284,	3095.76571,	3089.41774,	3085.44809,	3077.46709,	3070.72524,	3058.67900,	3049.61416,	3032.39869,	3040.65112,	3042.79968,	3049.22893,	 3066.45836,	3085.68543,
    3200.67449,	3116.13401,	3067.03075,	3027.30661,	2995.87328,	2971.40593,	2936.17759,	2924.90088,	2915.08261,	2901.13838,	2877.17537,	2858.03845,	2838.76964,	2775.55024,	2747.91366,	2713.37422,	2689.93149,	2680.89225,	 2655.99024,	2651.45761),
  9, 20, byrow = TRUE)

premium <- matrix(
  c(4.04591,   6.09630, 	7.80344,	 9.19793,	  10.37374,	 11.46395,	12.56648,	 13.62972,	14.29807,  15.13344,	16.05589,	 16.88807,	17.17164,	 20.39545,	20.85012, 	23.66660, 	25.19144,	  25.85265,	  28.37461,	  29.48189,
    8.76051,	 13.31890,	16.96633,	 19.88220,	22.34099,	 24.61668,	26.70537,	 29.06973,	30.63461,	 32.36956,	33.82844,	 35.49124,	37.11185,	 41.62326, 	43.59598,	  47.85277,	  50.66757,	  53.48670,	  56.90863,	  58.78810,
    25.63738,	 38.72006,	48.55113,	 56.02123,	62.69507,	 68.45116,	73.88912,	 79.23076,	83.38976,	 88.19195,	91.48696,	 95.26970,	99.10259,	 109.05083,	116.61710,	125.05124,	132.11392,	142.49675,	148.83927,	153.16853,
    39.12141,	 58.70472,	73.16519,	 84.13849,	93.54350,	 102.09505,	110.00364, 118.11260,	123.88137, 130.02476,	134.81104, 140.35163,	144.43151, 159.89766,	172.03441,	183.12813,	193.18669,	209.78766,	217.75606,	223.76290,
    63.75560,	 94.82047,	117.30666, 134.97887,	149.02536, 161.86370,	174.79557, 185.93284,	194.58421, 204.95063,	210.74070, 219.79702,	228.53392, 249.76775,	270.49337,	285.42398,	300.75159,	328.27813,	338.38864,	347.09451,
    96.40846,	 142.83167,	174.94003, 200.78505,	221.52607, 239.39765,	257.37317, 273.89133,	285.47994, 300.08282,	309.18325, 322.16482,	333.42435, 366.05966,	397.19781,	417.18387,	438.73247,	479.61160,	492.25180,	504.19395,
    125.69700, 184.94569,	225.95805, 257.54383,	284.12246, 307.66320,	330.42230, 351.35097,	366.11282, 384.27674,	395.74302, 411.59170,	426.12605, 466.78527,	507.76136,	530.78081,	557.82319,	609.82408,	623.59118,	637.91852,
    199.80716, 290.61482,	349.33652, 398.75352,	445.99600, 479.95146,	516.57026, 544.61680,	568.36712, 595.00910,	617.57484, 642.72655,	672.54276, 731.66216,	790.65854,	827.52567,	867.75543,	937.48879, 	958.76141, 	979.35795,
    253.68424, 363.40105,	441.03389, 504.73660,	557.26188, 602.25507,	658.06993, 689.11971,	713.93381, 747.09924,	782.11507, 815.79266,	849.18600, 947.86987,	1007.02913,	1071.28734,	1122.78507,	1185.29946,	1228.99202,	1256.99613),
  9, 20, byrow = TRUE)

vol <- matrix(
  c(0.2367011, 0.2334560,	0.2361716, 0.2414563, 0.2457030, 0.2499656,	0.2541060, 0.2586814,	0.2592076, 0.2604833,	0.2671246, 0.2702009,	0.2648068, 0.2906107,	0.2762999, 0.2998339,	0.3052477, 0.2885036,	0.3116008, 0.3165468,
    0.2264808, 0.2256168,	0.2272493, 0.2310400, 0.2342824, 0.2376930,	0.2390351, 0.2443654,	0.2461323, 0.2469578,	0.2491658, 0.2513774,	0.2541455, 0.2617720,	0.2558236, 0.2672232,	0.2703553, 0.2641363,	0.2749490, 0.2773202,
    0.2109640, 0.2090382,	0.2073347, 0.2075376, 0.2096702, 0.2107531,	0.2108963, 0.2122023,	0.2134919, 0.2144784,	0.2146859, 0.2148545,	0.2160038, 0.2178441,	0.2180052, 0.2217734,	0.2238127, 0.2243220,	0.2284862, 0.2294166,
    0.2041864, 0.2011427,	0.1983557, 0.1979252, 0.1986265, 0.1996303,	0.1994221, 0.2009990,	0.2014943, 0.2007841,	0.2008856, 0.2010194,	0.1997034, 0.2028430,	0.2044675, 0.2063258,	0.2079235, 0.2101822,	0.2125512, 0.2130862,
    0.1969861, 0.1925220,	0.1885620, 0.1884038, 0.1877786, 0.1878416,	0.1881969, 0.1878432,	0.1879096, 0.1880411,	0.1864613, 0.1870173,	0.1880070, 0.1883802,	0.1914744, 0.1914002,	0.1927478, 0.1962931,	0.1969702, 0.1971296,
    0.1920527, 0.1872751,	0.1817117, 0.1812384, 0.1806392, 0.1798341,	0.1794171, 0.1792711,	0.1786140, 0.1784329,	0.1773908, 0.1778182,	0.1779073, 0.1794062,	0.1830023, 0.1821206,	0.1831729, 0.1872806,	0.1870920, 0.1870578,
    0.1893153, 0.1835578,	0.1778184, 0.1761777, 0.1756912, 0.1753963,	0.1748959, 0.1746991,	0.1740746, 0.1737013,	0.1726519, 0.1727826,	0.1730098, 0.1742305,	0.1784751, 0.1767678,	0.1778193, 0.1821881,	0.1812986, 0.1811069,
    0.1880498, 0.1808654,	0.1726532, 0.1717044, 0.1741978, 0.1730214,	0.1732678, 0.1716915,	0.1715894, 0.1709688,	0.1716704, 0.1721885,	0.1748541, 0.1753996,	0.1790369, 0.1781090,	0.1792954, 0.1822103,	0.1817777, 0.1816887,
    0.1917631, 0.1820577,	0.1759998, 0.1758988, 0.1762197, 0.1761333,	0.1797913, 0.1770109,	0.1756026, 0.1751179,	0.1778657, 0.1791467,	0.1810767, 0.1883214,	0.1889558, 0.1926610,	0.1946013, 0.1930027,	0.1968736, 0.1977369),
  9, 20, byrow = TRUE)

## Plot ----

nmaturity <- length(maturity)
VTClist_fSabC1 <- Kahale_list_fSab(t(premium),
                                   t(strike),
                                   spot,
                                   maturity,
                                   "C1")
VTClist_fSabC2 <- Kahale_list_fSab(t(premium),
                                   t(strike),
                                   spot,
                                   maturity,
                                   "C2")

PlotSupPlotly(maturity,
              strike,
              spot,
              rate,
              divy,
              VTClist_fSabC1,
              type = "premium")
PlotSupPlotly(maturity,
              strike,
              spot,
              rate,
              divy,
              VTClist_fSabC1,
              type = "volatility")
PlotSupPlotly(maturity,
              strike,
              spot,
              rate,
              divy,
              VTClist_fSabC2,
              type = "premium")
PlotSupPlotly(maturity,
              strike,
              spot,
              rate,
              divy,
              VTClist_fSabC2,
              type = "volatility")